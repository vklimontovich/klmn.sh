---
- name: Check if Tailscale is installed
  command: tailscale --version
  register: tailscale_installed
  ignore_errors: true
  changed_when: false

- name: Install Tailscale
  when: tailscale_installed.rc != 0
  block:
    - name: Add Tailscale GPG key
      shell: |
        curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/$(lsb_release -cs).noarmor.gpg \
          -o /usr/share/keyrings/tailscale-archive-keyring.gpg
      args:
        creates: /usr/share/keyrings/tailscale-archive-keyring.gpg

    - name: Add Tailscale repository
      shell: |
        curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/$(lsb_release -cs).tailscale-keyring.list \
          -o /etc/apt/sources.list.d/tailscale.list
      args:
        creates: /etc/apt/sources.list.d/tailscale.list

    - name: Install Tailscale package
      apt:
        name: tailscale
        state: present
        update_cache: true

- name: Ensure Tailscale service is running
  systemd:
    name: tailscaled
    state: started
    enabled: true

- name: Check Tailscale status
  command: tailscale status --json
  register: tailscale_status
  changed_when: false
  ignore_errors: true

- name: Join Tailscale network
  command: tailscale up --authkey={{ tailscale_auth_key }} --reset --timeout=30s
  when: >
    tailscale_status.rc != 0 or
    (tailscale_status.stdout | from_json).BackendState != "Running"
  no_log: true

- name: Configure as exit node
  command: tailscale set --advertise-exit-node
  when: tailscale_exit_node | default(false)
